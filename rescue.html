<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</title>
  <style>
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background:#f5f5f5;
    }
    .header {
      background:#1976d2;
      color:#fff;
      padding:10px 12px;
      font-size:16px;
    }
    .header small { display:block; font-size:12px; opacity:0.9; }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 10px;
      font-size:14px;
    }

    .filters {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
      align-items:center;
    }
    .filters label {
      font-size:12px;
      margin-right:4px;
    }
    .filters select, .filters input {
      padding:4px 6px;
      font-size:13px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      font-size:13px;
    }
    th, td {
      border:1px solid #ddd;
      padding:4px 6px;
      vertical-align:top;
    }
    th {
      background:#e3f2fd;
      text-align:center;
      white-space:nowrap;
    }
    tr:nth-child(even) { background:#fafafa; }

    button.action {
      padding:4px 8px;
      font-size:12px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      background:#43a047;
      color:#fff;
    }
    button.action:disabled { opacity:0.6; cursor:default; }

    .status-bar {
      font-size:12px;
      margin:6px 0;
      color:#555;
    }
    @media (max-width:700px) {
      th, td { font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="header">
    üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS<br>
    <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore (collection: <b>cases</b>) | ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î (status = "open")</small>
  </div>

  <div class="container">
    <div class="filters">
      <div>
        <label for="filterProvince">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
        <select id="filterProvince">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div>
        <label for="filterDistrict">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</label>
        <select id="filterDistrict" disabled>
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div>
        <label for="filterSubdistrict">‡∏ï‡∏≥‡∏ö‡∏•:</label>
        <select id="filterSubdistrict" disabled>
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div>
        <label for="filterVillage">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏ä‡∏∏‡∏°‡∏ä‡∏ô:</label>
        <input id="filterVillage" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà 1)">
      </div>
    </div>

    <div class="status-bar" id="statusBar">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <table>
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="caseTableBody">
        <tr><td colspan="7" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
      </tbody>
    </table>
  </div>

  <!-- firebase config -->
  <script src="firebase-config.js"></script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      updateDoc,
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const statusBar       = document.getElementById('statusBar');
    const tbody           = document.getElementById('caseTableBody');
    const filterProvince  = document.getElementById('filterProvince');
    const filterDistrict  = document.getElementById('filterDistrict');
    const filterSubdistrict = document.getElementById('filterSubdistrict');
    const filterVillage   = document.getElementById('filterVillage');

    // dropdown ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
    const PROVINCE_URL    = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/province.json";
    const DISTRICT_URL    = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/district.json";
    const SUBDISTRICT_URL = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/sub_district.json";

    let provinces   = [];
    let districts   = [];
    let subdistricts= [];

    async function loadThaiData() {
      try {
        const [pRes, dRes, sRes] = await Promise.all([
          fetch(PROVINCE_URL),
          fetch(DISTRICT_URL),
          fetch(SUBDISTRICT_URL)
        ]);
        provinces    = await pRes.json();
        districts    = await dRes.json();
        subdistricts = await sRes.json();

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô filter
        provinces.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name_th;
          opt.textContent = p.name_th;
          filterProvince.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    filterProvince.addEventListener('change', () => {
      const provinceName = filterProvince.value;
      filterDistrict.innerHTML   = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
      filterSubdistrict.innerHTML= '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
      filterDistrict.disabled    = true;
      filterSubdistrict.disabled = true;

      if (!provinceName) {
        renderTable();
        return;
      }

      const provinceObj = provinces.find(p => p.name_th === provinceName);
      if (!provinceObj) { renderTable(); return; }

      const ds = districts.filter(d => d.province_id === provinceObj.id);
      ds.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name_th;
        opt.textContent = d.name_th;
        filterDistrict.appendChild(opt);
      });
      filterDistrict.disabled = false;
      renderTable();
    });

    filterDistrict.addEventListener('change', () => {
      const districtName = filterDistrict.value;
      filterSubdistrict.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
      filterSubdistrict.disabled  = true;

      if (!districtName) {
        renderTable();
        return;
      }

      const districtObj = districts.find(d => d.name_th === districtName);
      if (!districtObj) { renderTable(); return; }

      const subs = subdistricts.filter(s => s.district_id === districtObj.id);
      subs.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name_th;
        opt.textContent = s.name_th;
        filterSubdistrict.appendChild(opt);
      });
      filterSubdistrict.disabled = false;
      renderTable();
    });

    filterSubdistrict.addEventListener('change', renderTable);
    filterVillage.addEventListener('input', renderTable);

    let allCases = [];

    async function loadCases() {
      statusBar.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore...';
      try {
        const q = query(
          collection(db, 'cases'),
          where('status', '==', 'open')
        );
        const snap = await getDocs(q);
        allCases = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          allCases.push({ id: docSnap.id, ...data });
        });
        statusBar.textContent = `‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allCases.length} ‡πÄ‡∏Ñ‡∏™`;
        renderTable();
      } catch (err) {
        console.error(err);
        statusBar.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
      }
    }

    function renderTable() {
      let list = [...allCases];

      const p = filterProvince.value;
      const d = filterDistrict.value;
      const s = filterSubdistrict.value;
      const v = filterVillage.value.trim();

      if (p) list = list.filter(c => c.region?.province   === p);
      if (d) list = list.filter(c => c.region?.district   === d);
      if (s) list = list.filter(c => c.region?.subdistrict=== s);
      if (v) list = list.filter(c => (c.region?.village || '').includes(v));

      tbody.innerHTML = '';

      if (!list.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.style.textAlign = 'center';
        td.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      list.forEach((c) => {
        const tr = document.createElement('tr');

        const area = [
          c.region?.province || '',
          c.region?.district || '',
          c.region?.subdistrict || '',
          c.region?.village || ''
        ].filter(Boolean).join(' / ');

        const waterText = c.waterLevel
          ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${c.waterLevel}`
          : '';

        const latText = (typeof c.lat === 'number' && typeof c.lng === 'number')
          ? `${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`
          : '-';

        tr.innerHTML = `
          <td>${c.name || '-'}</td>
          <td>${c.phone || '-'}</td>
          <td>${area || '-'}</td>
          <td style="text-align:center;">${waterText}</td>
          <td>${c.note || c.address || '-'}</td>
          <td>${latText}</td>
          <td><button class="action" data-id="${c.id}">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button></td>
        `;

        tbody.appendChild(tr);
      });

      // ‡∏ú‡∏π‡∏Å event ‡∏õ‡∏∏‡πà‡∏° "‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
      tbody.querySelectorAll('button.action').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          closeCase(id, btn);
        });
      });
    }

    async function closeCase(id, buttonEl) {
      const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?');
      if (!ok) return;

      buttonEl.disabled = true;
      buttonEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        await updateDoc(doc(db, 'cases', id), {
          status: 'closed',
          resolvedAt: serverTimestamp()
        });
        // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å allCases ‡πÅ‡∏•‡∏∞ refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        allCases = allCases.filter(c => c.id !== id);
        renderTable();
        statusBar.textContent = `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | ‡πÄ‡∏Ñ‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${allCases.length} ‡πÄ‡∏Ñ‡∏™`;
      } catch (err) {
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        buttonEl.disabled = false;
        buttonEl.textContent = '‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    await loadThaiData();
    await loadCases();
  </script>
</body>
</html>
