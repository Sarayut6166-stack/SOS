<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; }
    .topbar {
      padding: 8px 12px;
      background:#1e88e5;
      color:#fff;
    }
    .topbar h1 { margin:0; font-size:18px; }
    .topbar small { font-size:12px; display:block; }
    #status { font-size:12px; margin-top:4px; color:#ffeb3b; }
    #status.error { color:#ff5252; font-weight:bold; }

    .container { padding: 8px 12px; max-width:960px; margin:auto; }

    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td {
      border:1px solid #ddd;
      padding:4px;
      vertical-align: top;
    }
    th { background:#f0f0f0; }

    #debug-box {
      margin-top:8px;
      background:#111;
      color:#0f0;
      font-size:11px;
      padding:6px;
      border-radius:4px;
      max-height:180px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</h1>
    <small>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Firestore (collection: cases)</small>
    <div id="status"></div>
  </div>

  <div class="container">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ (‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏∏‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô cases)</h3>
    <table>
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏´‡∏°‡∏π‡πà</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
          <th>status</th>
        </tr>
      </thead>
      <tbody id="caseTableBody"></tbody>
    </table>

    <div id="debug-box"></div>
  </div>

  <script type="module">
    // CONFIG ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå sos-rescue-system
    const firebaseConfig = {
      apiKey: "AIzaSyAbCi1b3xS4b2F-9gH14l8iv_r3X0MzW",
      authDomain: "sos-rescue-system.firebaseapp.com",
      projectId: "sos-rescue-system",
      storageBucket: "sos-rescue-system.appspot.com",
      messagingSenderId: "190787807954",
      appId: "1:190787807954:web:be172eecdf7de9bda2c6eb",
      measurementId: "G-S2ZR94V8JS"
    };

    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const statusEl = document.getElementById('status');
    const tbody    = document.getElementById('caseTableBody');
    const debugBox = document.getElementById('debug-box');

    function debug(msg, obj) {
      const time = new Date().toLocaleTimeString();
      debugBox.textContent += `[${time}] ${msg}\n`;
      if (obj !== undefined) {
        debugBox.textContent += JSON.stringify(obj, null, 2) + "\n";
      }
      debugBox.textContent += "------------------------------\n";
    }

    let db;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Firebase
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      debug('Firebase initialized');
    } catch (err) {
      console.error(err);
      statusEl.textContent = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      statusEl.classList.add('error');
      debug('Firebase init error', { message: err.message });
    }

    async function loadCases() {
      if (!db) {
        debug('‡πÑ‡∏°‡πà‡∏°‡∏µ db (Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)');
        return;
      }
      try {
        debug('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å getDocs(collection "cases")');
        const snap = await getDocs(collection(db, 'cases'));
        debug('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå getDocs', { size: snap.size });

        tbody.innerHTML = '';

        if (snap.empty) {
          statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà collection "cases" ‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)';
          return;
        }

        const rows = [];
        snap.forEach(docSnap => {
          rows.push({ id: docSnap.id, ...docSnap.data() });
        });
        debug('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Firestore', rows);

        rows.forEach(c => {
          const region = c.region || {};
          const lat   = c.lat;
          const lng   = c.lng;
          const water = c.waterLevel ?? c.waterlevel ?? '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.name || ''}</td>
            <td>${c.phone || ''}</td>
            <td>
              ${region.province || ''} /
              ${region.district || ''} /
              ${region.subdistrict || ''} /
              ${region.village || ''}
            </td>
            <td>${water}</td>
            <td>${c.note || ''}</td>
            <td>${lat !== undefined && lng !== undefined ? lat + ', ' + lng : ''}</td>
            <td>${c.status || ''}</td>
          `;
          tbody.appendChild(tr);
        });

        statusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + rows.length + ' ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        statusEl.classList.add('error');
        debug('getDocs error', { message: err.message });
      }
    }

    loadCases();
  </script>
</body>
</html>
