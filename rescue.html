<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ | SOS Rescue</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }

    .header {
      background: #1976d2;
      color: #fff;
      padding: 14px;
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
    }

    .filter-card {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 14px;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.15);
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-group {
      flex: 1;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.2);
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    th {
      background: #e3f2fd;
      font-weight: bold;
    }

    .btn-map {
      background: #1565c0;
      color: white;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      display: inline-block;
      text-decoration: none;
      margin-bottom: 3px;
    }

    .btn-finish {
      background: #2e7d32;
      color: white;
      padding: 5px 6px;
      border-radius: 6px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      margin-top: 6px;
    }

    .status-tag {
      background: #ef6c00;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .empty {
      text-align: center;
      padding: 16px;
      color: #777;
    }

    /* Popup Maps.me */
    #selectMapsPopup {
      display:none;
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(0,0,0,.6);
      z-index:99999;
      backdrop-filter:blur(2px);
    }

    #selectMapsBox {
      background:#fff;
      width:80%;
      max-width:360px;
      margin:120px auto;
      padding:16px;
      border-radius:12px;
      text-align:center;
    }

    .popup-btn{
      padding:10px;
      background:#2e7d32;
      margin-top:10px;
      border-radius:8px;
      text-decoration:none;
      font-size:14px;
      color:white;
      text-align:center;
      cursor:pointer;
    }

    .popup-close {
      background:#888 !important;
    }
  </style>
</head>

<body>

<!-- üî∞ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Maps.me -->
<div style="
  background:#fff3cd;
  color:#856404;
  padding:14px;
  border-left:6px solid #ffca2c;
  font-size:15px;
  margin:10px;
  border-radius:8px;
  line-height:1.5;
">
  üìå <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢</b><br>
  ‡∏´‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <b>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</b>  
  ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <b>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</b>  
  <span style="color:#d35400; font-weight:bold;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏û Maps.me</span>

  <div style="margin-top:8px;">
    üëâ <a href="https://apps.apple.com/us/app/maps-me-offline-maps-gps-nav/id510623322" target="_blank" style="color:#0d6efd; font-weight:bold;">
       ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Maps.me (iPhone / iPad)
    </a>
  </div>

  <div>
    üëâ <a href="https://play.google.com/store/apps/details?id=com.mapswithme.maps.pro" target="_blank" style="color:#0d6efd; font-weight:bold;">
       ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Maps.me (Android)
    </a>
  </div>
</div>

<!-- Popup Maps.me -->
<div id="selectMapsPopup">
  <div id="selectMapsBox">
    <h3>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Maps.me ‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?</h3>
    <div id="openSingle" class="popup-btn">üìç ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    <div id="openAll"   class="popup-btn">üìçüìç ‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
    <div class="popup-btn popup-close" onclick="closeSelectPopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
  </div>
</div>

<script>
window.openMapsChoice = (lat,lng)=>{
  selectedLatLng = {lat,lng};
  document.getElementById("selectMapsPopup").style.display="block";
};
window.closeSelectPopup = ()=>{
  document.getElementById("selectMapsPopup").style.display="none";
};
</script>

<div class="header">
  <h2>üöë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</h2>
</div>

<div class="container">

  <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
  <div class="filter-card">
    <b>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b>
    <div class="filter-row">

      <div class="filter-group">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
        <select id="filterProvince">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
        <select id="filterDistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
        <select id="filterSubdistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</label>
        <select id="filterPeople">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="1-3">1‚Äì3 ‡∏Ñ‡∏ô</option>
          <option value="4-6">4‚Äì6 ‡∏Ñ‡∏ô</option>
          <option value="7+">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 6 ‡∏Ñ‡∏ô</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
        <input id="filterText" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå">
      </div>

    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ô‡πâ‡∏≥</th>
        <th>‡∏Ñ‡∏ô</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody id="caseBody">
      <tr><td colspan="9" class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody>
  </table>

</div>

<script src="firebase-config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  onSnapshot, updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const pFilter  = document.getElementById("filterProvince");
const dFilter  = document.getElementById("filterDistrict");
const sFilter  = document.getElementById("filterSubdistrict");
const tFilter  = document.getElementById("filterText");
const pcFilter = document.getElementById("filterPeople");
const tbody    = document.getElementById("caseBody");

/* ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏ï‡∏≥‡∏ö‡∏• */
let provinces=[],districts=[],subdistricts=[];
const URL_P="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
const URL_D="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
const URL_S="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

async function loadThai(){
  provinces    = await (await fetch(URL_P)).json();
  districts    = await (await fetch(URL_D)).json();
  subdistricts = await (await fetch(URL_S)).json();

  provinces.forEach(p=>{
    pFilter.innerHTML += `<option>${p.name_th}</option>`;
  });
}
loadThai();

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î */
pFilter.addEventListener("change",()=>{
  const p = provinces.find(x=>x.name_th===pFilter.value);

  dFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  sFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(p){
    districts
      .filter(d=>d.province_id===p.id)
      .forEach(d=> dFilter.innerHTML += `<option>${d.name_th}</option>`);
  }
  renderTable();
});

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ */
dFilter.addEventListener("change",()=>{
  const d = districts.find(x=>x.name_th===dFilter.value);

  sFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(d){
    subdistricts
      .filter(s=>s.district_id===d.id)
      .forEach(s=> sFilter.innerHTML += `<option>${s.name_th}</option>`);
  }
  renderTable();
});

sFilter.addEventListener("change",renderTable);
tFilter.addEventListener("input",renderTable);
pcFilter.addEventListener("change",renderTable);

/* Firestore realtime */
let allCases=[];
onSnapshot(
  query(collection(db,"cases"), where("status","==","open")),
  snap=>{
    allCases = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderTable();
  }
);

/* Helper */
function showRegion(r){
  if(!r) return "-";
  return [
    r.village,
    r.subdistrict,
    r.district,
    r.province
  ].filter(Boolean).join(" / ");
}

function levelBadge(lv){
  const color =
    lv==1 ? "#8bc34a" :
    lv==2 ? "#4caf50" :
    lv==3 ? "#ffb300" :
    lv==4 ? "#fb8c00" :
            "#e53935";

  return `<span style="color:white;padding:3px 6px;border-radius:8px;background:${color};">${lv}</span>`;
}

/* render table */
function renderTable(){

  const p  = pFilter.value;
  const d  = dFilter.value;
  const s  = sFilter.value;
  const t  = tFilter.value.trim().toLowerCase();
  const pc = pcFilter.value;

  const list = allCases.filter(c=>{
    const r = c.region || {};
    const pp = Number(c.people||0);

    if(p && r.province!==p) return false;
    if(d && r.district!==d) return false;
    if(s && r.subdistrict!==s) return false;

    if(t){
      const text = `${c.name||""} ${c.phone||""}`.toLowerCase();
      if(!text.includes(t)) return false;
    }

    if(pc){
      if(pc==="1-3" && !(pp>=1 && pp<=3)) return false;
      if(pc==="4-6" && !(pp>=4 && pp<=6)) return false;
      if(pc==="7+"  && !(pp>=7))          return false;
    }

    return true;
  });

  if(!list.length){
    tbody.innerHTML=`<tr><td colspan="9" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map((c,i)=>{
    const lat=c.lat, lng=c.lng;

    let mapsUI = "-";
    if(typeof lat==="number"){
      const gUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      mapsUI = `
        <a class="btn-map" href="${gUrl}" target="_blank">Google Maps</a><br>
        <a class="btn-map" href="javascript:void(0)" onclick="openMapsChoice(${lat},${lng})">Maps.me</a>
      `;
    }

    return `
      <tr>
        <td>${i+1}</td>
        <td>${c.name||"-"}</td>
        <td>${c.phone||"-"}</td>
        <td>${showRegion(c.region)}</td>
        <td>${levelBadge(c.waterLevel)}</td>
        <td>${c.people}</td>
        <td>${c.note||"-"}</td>
        <td>${mapsUI}</td>
        <td>
          <span class="status-tag">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><br>
          <button class="btn-finish" onclick="closeCase('${c.id}')">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* Maps.me action */
let selectedLatLng=null;

document.getElementById("openSingle").onclick = ()=>{
  const {lat,lng}=selectedLatLng;
  window.location.href = `mapsme://map?ll=${lat},${lng}&n=‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢`;
  closeSelectPopup();
};

document.getElementById("openAll").onclick = ()=>{

  const p=pFilter.value, d=dFilter.value, s=sFilter.value;
  const t=tFilter.value.trim().toLowerCase();
  const pc=pcFilter.value;

  const cases = allCases.filter(c=>{
    const r=c.region||{};
    const pp=Number(c.people||0);

    if(p && r.province!==p) return false;
    if(d && r.district!==d) return false;
    if(s && r.subdistrict!==s) return false;

    if(pc){
      if(pc==="1-3" && !(pp>=1&&pp<=3)) return false;
      if(pc==="4-6" && !(pp>=4&&pp<=6)) return false;
      if(pc==="7+"  && !(pp>=7))        return false;
    }

    if(t){
      const text=`${c.name||""} ${c.phone||""}`.toLowerCase();
      if(!text.includes(t)) return false;
    }

    return typeof c.lat==="number";
  });

  if(!cases.length){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î");
    return;
  }

  let url="mapsme://map?";
  cases.forEach(c=>{
    url+=`ll=${c.lat},${c.lng}&`;
  });

  window.location.href=url;
  closeSelectPopup();
};

/* ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ */
window.closeCase = async (id)=>{
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;
  await updateDoc(doc(db,"cases",id),{
    status:"closed",
    closedAt:serverTimestamp()
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};
</script>

</body>
</html>
