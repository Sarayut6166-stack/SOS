<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ | SOS Rescue</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }

    .header {
      background: #1976d2;
      color: #fff;
      padding: 14px;
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
    }

    .filter-card {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 14px;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.15);
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-group {
      flex: 1;
      min-width: 150px;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }

    select, input {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.2);
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    th {
      background: #e3f2fd;
      font-weight: bold;
    }

    .btn-map {
      background: #1565c0;
      color: white;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      display: inline-block;
      text-decoration: none;
      margin-bottom: 3px;
    }

    .btn-finish {
      background: #2e7d32;
      color: white;
      padding: 5px 6px;
      border-radius: 6px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      margin-top: 6px;
    }

    .status-tag {
      background: #ef6c00;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .empty {
      text-align: center;
      padding: 16px;
      color: #777;
    }

    /* Popup Maps.me */
    #mapsmePopup {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    #mapsmeBox {
      background: #fff;
      width: 80%;
      max-width: 350px;
      margin: 120px auto;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .popup-btn {
      display: block;
      margin-top: 10px;
      padding: 10px;
      background: #2e7d32;
      border-radius: 8px;
      color: white;
      text-decoration: none;
    }

    .popup-close {
      background: #888;
    }
  </style>
</head>

<body>

<!-- Popup ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Maps.me -->
<div id="mapsmePopup">
  <div id="mapsmeBox">
    <h3>üìå ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone/iPad</h3>
    <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ <b>Maps.me</b></p>
    <a class="popup-btn"
       href="https://apps.apple.com/us/app/maps-me-offline-maps-gps-nav/id510623322"
       target="_blank">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Maps.me</a>
    <a class="popup-btn popup-close" onclick="closePopup()">‡∏õ‡∏¥‡∏î</a>
  </div>
</div>

<script>
  function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  function closePopup() {
    document.getElementById("mapsmePopup").style.display = "none";
    localStorage.setItem("mapsPopupSeen", Date.now() + 86400000);
  }

  window.addEventListener("load", () => {
    if (!isIOS()) return;
    const seen = localStorage.getItem("mapsPopupSeen");
    if (seen && Number(seen) > Date.now()) return;
    document.getElementById("mapsmePopup").style.display = "block";
  });
</script>


<div class="header">
  <h2>üöë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</h2>
</div>

<div class="container">

  <div class="filter-card">
    <b>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b>
    <div class="filter-row">

      <div class="filter-group">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
        <select id="filterProvince">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
        <select id="filterDistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
        <select id="filterSubdistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏û‡∏¢‡∏û</label>
        <select id="filterPeople">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="1-3">1‚Äì3 ‡∏Ñ‡∏ô</option>
          <option value="4-6">4‚Äì6 ‡∏Ñ‡∏ô</option>
          <option value="7+">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 6 ‡∏Ñ‡∏ô</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
        <input id="filterText" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
      </div>

    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ô‡πâ‡∏≥</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody id="caseBody"></tbody>
  </table>

</div>

<script src="firebase-config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  onSnapshot, updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const tbody = document.getElementById("caseBody");

let provinces=[],districts=[],subdistricts=[];
const URL_P = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
const URL_D = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
const URL_S = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

async function loadThai() {
  provinces    = await (await fetch(URL_P)).json();
  districts    = await (await fetch(URL_D)).json();
  subdistricts = await (await fetch(URL_S)).json();

  provinces.forEach(p=>{
    filterProvince.innerHTML += `<option>${p.name_th}</option>`;
  });
}

loadThai();

/* ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô */
filterProvince.addEventListener("change",()=>{
  const pObj = provinces.find(x=>x.name_th===filterProvince.value);
  filterDistrict.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  filterSubdistrict.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(pObj){
    districts.filter(d=>d.province_id===pObj.id)
             .forEach(d=>filterDistrict.innerHTML+=`<option>${d.name_th}</option>`);
  }

  renderTable();
});

filterDistrict.addEventListener("change",()=>{
  const dObj = districts.find(x=>x.name_th===filterDistrict.value);
  filterSubdistrict.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(dObj){
    subdistricts.filter(s=>s.district_id===dObj.id)
                .forEach(s=>filterSubdistrict.innerHTML+=`<option>${s.name_th}</option>`);
  }

  renderTable();
});

filterSubdistrict.addEventListener("change",renderTable);
filterText.addEventListener("input",renderTable);
filterPeople.addEventListener("change",renderTable);

let allCases = [];

/* ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase realtime */
onSnapshot(
  query(collection(db,"cases"), where("status","==","open")),
  snap => {
    allCases = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderTable();
  }
);

function showRegion(r){
  return [
    r.village,
    r.subdistrict,
    r.district,
    r.province
  ].filter(Boolean).join(" / ");
}

function levelBadge(lv){
  return `<span style="color:white;padding:3px 6px;border-radius:8px;background:
    ${lv==1?'#8bc34a':
      lv==2?'#4caf50':
      lv==3?'#fb8c00':
      lv==4?'#ef6c00':
             '#e53935'}">‡∏£‡∏∞‡∏î‡∏±‡∏ö ${lv}</span>`;
}

function renderTable(){
  const p = filterProvince.value;
  const d = filterDistrict.value;
  const s = filterSubdistrict.value;
  const t = filterText.value.trim().toLowerCase();
  const pc = filterPeople.value;

  const list = allCases.filter(c=>{
    const r = c.region || {};

    if(p && r.province!==p) return false;
    if(d && r.district!==d) return false;
    if(s && r.subdistrict!==s) return false;

    if(t){
      if(!(`${c.name} ${c.phone}`.toLowerCase().includes(t))) return false;
    }

    if(pc){
      const people = Number(c.people || 0);
      if(pc==="1-3" && !(people>=1 && people<=3)) return false;
      if(pc==="4-6" && !(people>=4 && people<=6)) return false;
      if(pc==="7+"  && !(people>=7)) return false;
    }

    return true;
  });

  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="9" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map((c,i)=>{
    const lat=c.lat, lng=c.lng;

    let maps = "-";
    if(typeof lat==="number"){
      const g = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      const m = `mapsme://map?ll=${lat},${lng}`;
      maps = `
        <a class="btn-map" href="${g}" target="_blank">Google Maps</a><br>
        <a class="btn-map" href="${m}">Maps.me</a>
      `;
    }

    return `
      <tr>
        <td>${i+1}</td>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${showRegion(c.region)}</td>
        <td>${levelBadge(c.waterLevel)}</td>
        <td>${c.people || '-'}</td>
        <td>${c.note || '-'}</td>
        <td>${maps}</td>
        <td><span class="status-tag">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><br>
            <button class="btn-finish" onclick="closeCase('${c.id}')">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button></td>
      </tr>
    `;
  }).join("");
}

window.closeCase = async function(id){
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;
  await updateDoc(doc(db,"cases",id),{
    status:"closed",
    closedAt:serverTimestamp()
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};

</script>

</body>
</html>
