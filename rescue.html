<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ | SOS Rescue</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }

    .header {
      background: #1976d2;
      color: #fff;
      padding: 14px;
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
    }

    .filter-card {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 14px;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.15);
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-group {
      flex: 1;
      min-width: 150px;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }

    select, input {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.2);
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    th {
      background: #e3f2fd;
      font-weight: bold;
    }

    .btn-map {
      background: #1565c0;
      color: white;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      display: inline-block;
      text-decoration: none;
      margin-bottom: 3px;
    }

    .btn-finish {
      background: #2e7d32;
      color: white;
      padding: 5px 6px;
      border-radius: 6px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      margin-top: 6px;
    }

    .status-tag {
      background: #ef6c00;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .empty {
      text-align: center;
      padding: 16px;
      color: #777;
    }

    /* Popup Maps.me Suggestion */
    #mapsmePopup {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    #mapsmeBox {
      background: #fff;
      width: 80%;
      max-width: 350px;
      margin: 120px auto;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    /* Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
    #selectMapsPopup {
      display:none;
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(0,0,0,.6);
      z-index:99999;
      backdrop-filter:blur(2px);
    }

    #selectMapsBox {
      background:#fff;
      width:80%;
      max-width:360px;
      margin:120px auto;
      padding:16px;
      border-radius:12px;
      text-align:center;
    }

    .popup-btn{
      padding:10px;
      background:#2e7d32;
      margin-top:10px;
      border-radius:8px;
      text-decoration:none;
      font-size:14px;
      color:white;
      text-align:center;
      cursor:pointer;
    }

    .popup-close {
      background:#888 !important;
    }
  </style>
</head>

<body>

<!-- Popup ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Maps.me -->
<div id="mapsmePopup">
  <div id="mapsmeBox">
    <h3>üìå ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone/iPad</h3>
    <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï  
    ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ <b>Maps.me</b></p>

    <a class="popup-btn"
       href="https://apps.apple.com/us/app/maps-me-offline-maps-gps-nav/id510623322"
       target="_blank">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Maps.me</a>

    <a class="popup-btn popup-close" onclick="closeIOSPopup()">‡∏õ‡∏¥‡∏î</a>
  </div>
</div>

<!-- Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
<div id="selectMapsPopup">
  <div id="selectMapsBox">
    <h3>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?</h3>
    <div id="openSingle" class="popup-btn">üìç ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    <div id="openAll" class="popup-btn">üìçüìç ‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
    <div class="popup-btn popup-close" onclick="closeSelectPopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
  </div>
</div>

<script>
function isIOS(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function closeIOSPopup(){
  document.getElementById("mapsmePopup").style.display="none";
  localStorage.setItem("mapsInfoSeen", Date.now()+86400000);
}

window.addEventListener("load",()=>{
  if(!isIOS()) return;
  const seen=localStorage.getItem("mapsInfoSeen");
  if(seen && Number(seen)>Date.now()) return;
  document.getElementById("mapsmePopup").style.display="block";
});
</script>

<div class="header">
  <h2>üöë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</h2>
</div>

<div class="container">

  <div class="filter-card">
    <b>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b>
    <div class="filter-row">

      <div class="filter-group">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
        <select id="filterProvince">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
        <select id="filterDistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
        <select id="filterSubdistrict">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏û‡∏¢‡∏û</label>
        <select id="filterPeople">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="1-3">1‚Äì3 ‡∏Ñ‡∏ô</option>
          <option value="4-6">4‚Äì6 ‡∏Ñ‡∏ô</option>
          <option value="7+">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 6 ‡∏Ñ‡∏ô</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
        <input id="filterText" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
      </div>

    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ô‡πâ‡∏≥</th>
        <th>‡∏Ñ‡∏ô</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody id="caseBody">
      <tr><td colspan="9" class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody>
  </table>

</div>

<script src="firebase-config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  onSnapshot, updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* DOM References */
const pFilter  = document.getElementById("filterProvince");
const dFilter  = document.getElementById("filterDistrict");
const sFilter  = document.getElementById("filterSubdistrict");
const tFilter  = document.getElementById("filterText");
const pcFilter = document.getElementById("filterPeople");
const tbody    = document.getElementById("caseBody");

/* Load Provinces / Districts / Subdistricts */
let provinces=[],districts=[],subdistricts=[];
const URL_P="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
const URL_D="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
const URL_S="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

async function loadThai(){
  provinces    = await (await fetch(URL_P)).json();
  districts    = await (await fetch(URL_D)).json();
  subdistricts = await (await fetch(URL_S)).json();

  provinces.forEach(p=>{
    pFilter.innerHTML += `<option>${p.name_th}</option>`;
  });
}
loadThai();

/* ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏î Google ‡∏´‡∏£‡∏∑‡∏≠ Maps.me */
let selectedMapApp = null;
let selectedLatLng = null;

/* ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î */
window.openMapsChoice = (app, lat, lng)=>{
  selectedMapApp = app;     // google / mapsme
  selectedLatLng = {lat,lng};
  document.getElementById("selectMapsPopup").style.display="block";
};

window.closeSelectPopup = ()=>{
  document.getElementById("selectMapsPopup").style.display="none";
};

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î */
pFilter.addEventListener("change",()=>{
  const pObj=provinces.find(x=>x.name_th===pFilter.value);
  dFilter.innerHTML=`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  sFilter.innerHTML=`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(pObj){
    districts
      .filter(d=>d.province_id===pObj.id)
      .forEach(d=>dFilter.innerHTML+=`<option>${d.name_th}</option>`);
  }
  renderTable();
});

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ */
dFilter.addEventListener("change",()=>{
  const dObj=districts.find(x=>x.name_th===dFilter.value);
  sFilter.innerHTML=`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

  if(dObj){
    subdistricts
      .filter(s=>s.district_id===dObj.id)
      .forEach(s=>sFilter.innerHTML+=`<option>${s.name_th}</option>`);
  }
  renderTable();
});

sFilter.addEventListener("change",renderTable);
tFilter.addEventListener("input",renderTable);
pcFilter.addEventListener("change",renderTable);

/* Real-time Firestore Listener */
let allCases=[];
onSnapshot(
  query(collection(db,"cases"), where("status","==","open")),
  snap=>{
    allCases = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderTable();
  }
);

/* Helper ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
function showRegion(r){
  if(!r) return "-";
  return [
    r.village,
    r.subdistrict,
    r.district,
    r.province
  ].filter(Boolean).join(" / ");
}

/* Helper Badge ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ */
function levelBadge(lv){
  const color =
    lv==1 ? "#8bc34a" :
    lv==2 ? "#4caf50" :
    lv==3 ? "#fb8c00" :
    lv==4 ? "#ef6c00" :
            "#e53935";

  return `<span style="
    color:#fff; padding:3px 6px; border-radius:8px; background:${color};
  ">${lv}</span>`;
}

/* Render Table */
function renderTable(){
  const p  = pFilter.value;
  const d  = dFilter.value;
  const s  = sFilter.value;
  const t  = tFilter.value.trim().toLowerCase();
  const pc = pcFilter.value;

  const list = allCases.filter(c=>{
    const r = c.region || {};
    const pp = Number(c.people || 0);

    if(p && r.province!==p) return false;
    if(d && r.district!==d) return false;
    if(s && r.subdistrict!==s) return false;

    if(t){
      const text = `${c.name||""} ${c.phone||""}`.toLowerCase();
      if(!text.includes(t)) return false;
    }

    if(pc){
      if(pc==="1-3" && !(pp>=1 && pp<=3)) return false;
      if(pc==="4-6" && !(pp>=4 && pp<=6)) return false;
      if(pc==="7+"  && !(pp>=7)) return false;
    }

    return true;
  });

  if(!list.length){
    tbody.innerHTML=`<tr><td colspan="9" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map((c,i)=>{
    const lat=c.lat, lng=c.lng;

    const mapsUI = (typeof lat==="number")
      ? `
        <a class="btn-map"
           href="javascript:void(0)"
           onclick="openMapsChoice('google',${lat},${lng})">
           Google Maps
        </a><br>

        <a class="btn-map"
           href="javascript:void(0)"
           onclick="openMapsChoice('mapsme',${lat},${lng})">
           Maps.me
        </a>
      `
      : "-";

    return `
      <tr>
        <td>${i+1}</td>
        <td>${c.name || '-'}</td>
        <td>${c.phone || '-'}</td>
        <td>${showRegion(c.region)}</td>
        <td>${levelBadge(c.waterLevel)}</td>
        <td>${c.people}</td>
        <td>${c.note || '-'}</td>
        <td>${mapsUI}</td>
        <td>
          <span class="status-tag">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><br>
          <button class="btn-finish" onclick="closeCase('${c.id}')">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
document.getElementById("openSingle").onclick = ()=>{
  if(!selectedLatLng || !selectedMapApp) return;
  const {lat,lng} = selectedLatLng;

  if(selectedMapApp==="google"){
    const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    window.open(url,"_blank");
  } else {
    const url=`mapsme://map?ll=${lat},${lng}&n=‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢`;
    window.location.href = url;
  }

  closeSelectPopup();
};

/* ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
document.getElementById("openAll").onclick = ()=>{
  if(!selectedMapApp) return;

  const p  = pFilter.value;
  const d  = dFilter.value;
  const s  = sFilter.value;
  const t  = tFilter.value.trim().toLowerCase();
  const pc = pcFilter.value;

  const cases = allCases.filter(c=>{
    const r=c.region||{};
    const pp = Number(c.people||0);

    if(p && r.province!==p) return false;
    if(d && r.district!==d) return false;
    if(s && r.subdistrict!==s) return false;

    if(pc){
      if(pc==="1-3" && !(pp>=1 && pp<=3)) return false;
      if(pc==="4-6" && !(pp>=4 && pp<=6)) return false;
      if(pc==="7+"  && !(pp>=7)) return false;
    }

    if(t){
      const text=`${c.name||""} ${c.phone||""}`.toLowerCase();
      if(!text.includes(t)) return false;
    }

    return typeof c.lat==="number" && typeof c.lng==="number";
  });

  if(!cases.length){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ");
    return;
  }

  if(selectedMapApp==="google"){
    /* ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏°‡∏∏‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î */
    let url = "https://www.google.com/maps?";
    cases.forEach(c=>{
      url += `q=${c.lat},${c.lng}&`;
    });
    window.open(url,"_blank");

  } else {
    /* ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô Maps.me */
    let url="mapsme://map?";
    cases.forEach(c=>{
      url+=`ll=${c.lat},${c.lng}&`;
    });
    window.location.href=url;
  }

  closeSelectPopup();
};

/* ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ */
window.closeCase = async (id)=>{
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;
  await updateDoc(doc(db,"cases",id),{
    status:"closed",
    closedAt:serverTimestamp()
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};

</script>

</body>
</html>
