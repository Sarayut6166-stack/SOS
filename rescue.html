<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</title>

  <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; }
    .topbar {
      padding: 8px 12px;
      background:#1e88e5;
      color:#fff;
    }
    .topbar h1 { margin:0; font-size:18px; }
    .topbar small { font-size:12px; display:block; }
    #status { font-size:12px; margin-top:4px; color:#ffeb3b; }
    #status.error { color:#ff5252; font-weight:bold; }

    #map { height: 40vh; }

    .container { padding: 8px 12px; max-width:960px; margin:auto; }

    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td {
      border:1px solid #ddd;
      padding:4px;
      vertical-align: top;
    }
    th { background:#f0f0f0; }

    button {
      padding:4px 8px;
      font-size:12px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .btn-done { background:#43a047; color:#fff; margin-right:4px; }
    .btn-del  { background:#e53935; color:#fff; }

    #debug-box {
      margin-top:8px;
      background:#111;
      color:#0f0;
      font-size:11px;
      padding:6px;
      border-radius:4px;
      max-height:180px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</h1>
    <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore (collection: cases)</small>
    <div id="status"></div>
  </div>

  <div id="map"></div>

  <div class="container">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)</h3>
    <table>
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="caseTableBody"></tbody>
    </table>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á debug ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏≤‡∏ï‡πâ‡∏≤‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Firestore -->
    <div id="debug-box"></div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ‡πÉ‡∏ä‡πâ Firebase ‡πÅ‡∏ö‡∏ö config ‡∏ï‡∏£‡∏á ‡πÜ -->
  <script type="module">
    // ==== CONFIG ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå sos-rescue-system ====
    const firebaseConfig = {
      apiKey: "AIzaSyAbCi1b3xS4b2F-9gH14l8iv_r3X0MzW",
      authDomain: "sos-rescue-system.firebaseapp.com",
      projectId: "sos-rescue-system",
      storageBucket: "sos-rescue-system.appspot.com",
      messagingSenderId: "190787807954",
      appId: "1:190787807954:web:be172eecdf7de9bda2c6eb",
      measurementId: "G-S2ZR94V8JS"
    };

    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const statusEl = document.getElementById('status');
    const tbody    = document.getElementById('caseTableBody');
    const debugBox = document.getElementById('debug-box');

    let db;

    function debug(msg, obj) {
      const time = new Date().toLocaleTimeString();
      debugBox.textContent += `[${time}] ${msg}\n`;
      if (obj !== undefined) {
        debugBox.textContent += JSON.stringify(obj, null, 2) + "\n";
      }
      debugBox.textContent += "------------------------------\n";
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Firebase
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore...';
      debug('Firebase initialized', firebaseConfig);
    } catch (err) {
      console.error(err);
      statusEl.textContent = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      statusEl.classList.add('error');
      debug('Firebase init error', { message: err.message });
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    const map = L.map('map').setView([7.0, 100.5], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    const markers = {};
    const levelColor = {
      1: "#4caf50",
      2: "#8bc34a",
      3: "#ffeb3b",
      4: "#ff9800",
      5: "#f44336"
    };

    async function loadCases() {
      if (!db) {
        debug('loadCases skipped: no db');
        return;
      }
      try {
        debug('Calling getDocs(cases)...');
        const snap = await getDocs(collection(db, 'cases'));

        debug('getDocs result', { size: snap.size });

        tbody.innerHTML = '';
        for (const id in markers) {
          map.removeLayer(markers[id]);
          delete markers[id];
        }

        if (snap.empty) {
          statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ (snap.size = 0)';
          return;
        }

        const raw = [];
        snap.forEach(docSnap => {
          raw.push({ id: docSnap.id, ...docSnap.data() });
        });
        debug('Raw documents', raw);

        raw.forEach(c => {
          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ status = "open" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ status
          if (c.status && c.status !== 'open') return;

          const region = c.region || {};
          const name  = c.name  || '';
          const phone = c.phone || '';
          const note  = c.note  || '';
          const lat   = typeof c.lat === 'number' ? c.lat : null;
          const lng   = typeof c.lng === 'number' ? c.lng : null;
          const water = c.waterLevel ?? c.waterlevel ?? '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name}</td>
            <td>${phone ? <a href="tel:${phone}">${phone}</a> : ''}</td>
            <td>
              ${region.province || ''}<br>
              ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}
            </td>
            <td>‡∏£‡∏∞‡∏î‡∏±‡∏ö ${water}</td>
            <td>${note}</td>
            <td>${lat !== null && lng !== null ? ${lat.toFixed(5)}, ${lng.toFixed(5)} : ''}</td>
            <td>
              <button class="btn-done" data-id="${c.id}">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
              <button class="btn-del"  data-id="${c.id}">‡∏•‡∏ö</button>
            </td>
          `;
          tbody.appendChild(tr);

          if (lat !== null && lng !== null) {
            const color = levelColor[water] || "#000";
            const marker = L.circleMarker([lat, lng], {
              radius: 9,
              color,
              fillColor: color,
              fillOpacity: 0.85
            }).addTo(map)
              .bindPopup(`
                <strong>${name}</strong><br>
                ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}<br>
                ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}<br>
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥: ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${water}
              `);
            markers[c.id] = marker;
          }
        });

        statusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + raw.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        statusEl.classList.add('error');
        debug('getDocs error', { message: err.message });
      }
    }

    loadCases();

    // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    tbody.addEventListener('click', async (e) => {
      const id = e.target.getAttribute('data-id');
      if (!id || !db) return;
      const ref = doc(db, 'cases', id);

      if (e.target.classList.contains('btn-done')) {
        if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?')) {
          await updateDoc(ref, { status: 'resolved' });
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          loadCases();
        }
      } else if (e.target.classList.contains('btn-del')) {
        if (confirm('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) {
          await deleteDoc(ref);
          alert('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          loadCases();
        }
      }
    });

    // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if (!window._meMarker) {
          window._meMarker = L.circleMarker([lat, lng], {
            radius: 8,
            color: "#2196f3",
            fillColor: "#2196f3",
            fillOpacity: 0.9
          }).addTo(map).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢');
        } else {
          window._meMarker.setLatLng([lat, lng]);
        }
      });
    }
  </script>
</body>
</html>
