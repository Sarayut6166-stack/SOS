<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</title>

  <!-- Leaflet map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background:#f5f5f5;
    }

    .topbar {
      padding: 8px 12px;
      background:#1e88e5;
      color:#fff;
    }
    .topbar h1 {
      margin:0;
      font-size:18px;
    }
    .topbar small {
      font-size:12px;
      display:block;
      opacity:0.9;
    }
    #status {
      font-size:12px;
      margin-top:4px;
      color:#ffeb3b;
    }
    #status.error {
      color:#ff5252;
      font-weight:bold;
    }

    .filters {
      padding:8px 12px;
      background:#fff;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      border-bottom:1px solid #ddd;
    }
    .filters select {
      padding:4px 6px;
      font-size:13px;
      border-radius:6px;
      border:1px solid #ccc;
    }
    .filters label {
      font-size:12px;
      color:#333;
      display:flex;
      flex-direction:column;
    }

    #map {
      height: 40vh;
      width:100%;
    }

    .container {
      max-width: 1024px;
      margin:auto;
      padding:8px 12px 16px;
    }

    h3 {
      margin:8px 0;
      font-size:16px;
    }

    .table-wrapper {
      background:#fff;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      overflow-x:auto;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      min-width:700px;
    }
    th, td {
      border:1px solid #eee;
      padding:6px 4px;
      vertical-align:top;
      text-align:left;
    }
    th {
      background:#f2f2f2;
      position:sticky;
      top:0;
      z-index:1;
    }

    button {
      padding:4px 8px;
      font-size:12px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-done {
      background:#43a047;
      color:#fff;
      margin-right:4px;
    }
    .btn-del {
      background:#e53935;
      color:#fff;
    }
    .tag-open {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#ff9800;
      color:#fff;
      font-size:11px;
    }
    .tag-resolved {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#43a047;
      color:#fff;
      font-size:11px;
    }

    .badge-level {
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      font-size:11px;
      color:#fff;
    }

    @media (max-width: 600px) {
      .filters {
        flex-direction:column;
        align-items:flex-start;
      }
      #map {
        height: 35vh;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</h1>
    <small>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Realtime ‡∏à‡∏≤‡∏Å Firestore (collection: <b>cases</b>)</small>
    <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...</div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  <div class="filters">
    <label>
      ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      <select id="filter-province">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
      </select>
    </label>
    <label>
      ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
      <select id="filter-district">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
        <option value="‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
        <option value="‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°">‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°</option>
      </select>
    </label>
    <label>
      ‡∏ï‡∏≥‡∏ö‡∏• / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•
      <select id="filter-subdistrict">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏">‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏</option>
        <option value="‡∏Ñ‡∏•‡∏≠‡∏á‡πÅ‡∏´">‡∏Ñ‡∏•‡∏≠‡∏á‡πÅ‡∏´</option>
        <option value="‡∏û‡∏∞‡∏ß‡∏á">‡∏û‡∏∞‡∏ß‡∏á</option>
      </select>
    </label>
    <label>
      ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥
      <select id="filter-water">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
        <option value="1">1 - ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
        <option value="2">2 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</option>
        <option value="3">3 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
        <option value="4">4 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</option>
        <option value="5">5 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å</option>
      </select>
    </label>
  </div>

  <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
  <div id="map"></div>

  <div class="container">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
            <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="caseTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase + Firestore -->
  <script type="module">
    // ====== CONFIG ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå sos-rescue-system ======
    const firebaseConfig = {
      apiKey: "AIzaSyAbCi1b3xS4b2F-9gH14l8iv_r3X0MzW",
      authDomain: "sos-rescue-system.firebaseapp.com",
      projectId: "sos-rescue-system",
      storageBucket: "sos-rescue-system.appspot.com",
      messagingSenderId: "190787807954",
      appId: "1:190787807954:web:be172eecdf7de9bda2c6eb",
      measurementId: "G-S2ZR94V8JS"
    };

    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      updateDoc,
      deleteDoc,
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const statusEl = document.getElementById('status');
    const tbody    = document.getElementById('caseTableBody');

    const filterProvince   = document.getElementById('filter-province');
    const filterDistrict   = document.getElementById('filter-district');
    const filterSubdistrict= document.getElementById('filter-subdistrict');
    const filterWater      = document.getElementById('filter-water');

    let db;
    let allCases = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏à‡∏≤‡∏Å onSnapshot

    // ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥
    const levelColor = {
      1: "#4caf50",
      2: "#8bc34a",
      3: "#ffeb3b",
      4: "#ff9800",
      5: "#f44336"
    };

    // ====== ‡πÄ‡∏£‡∏¥‡πà‡∏° Firebase ======
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Realtime...';
    } catch (err) {
      console.error(err);
      statusEl.textContent = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      statusEl.classList.add('error');
    }

    // ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ======
    const map = L.map('map').setView([7.0, 100.5], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    const markers = {};

    function clearMarkers() {
      for (const id in markers) {
        map.removeLayer(markers[id]);
        delete markers[id];
      }
    }

    function renderMarkers(cases) {
      clearMarkers();
      cases.forEach(c => {
        if (typeof c.lat !== 'number' || typeof c.lng !== 'number') return;
        const color = levelColor[c.waterLevel] || "#000";
        const region = c.region || {};
        const popupHtml = `
          <strong>${c.name || ''}</strong><br>
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${c.phone || ''}<br>
          ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${region.province || ''} ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}<br>
          ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥: ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${c.waterLevel ?? '-'}<br>
          ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${c.note || ''}
        `;
        const m = L.circleMarker([c.lat, c.lng], {
          radius: 9,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map).bindPopup(popupHtml);
        markers[c.id] = m;
      });
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if (!window._meMarker) {
          window._meMarker = L.circleMarker([lat, lng], {
            radius: 8,
            color: "#2196f3",
            fillColor: "#2196f3",
            fillOpacity: 0.9
          }).addTo(map).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢');
        } else {
          window._meMarker.setLatLng([lat, lng]);
        }
      });
    }

    // ====== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ======
    function renderTable() {
      // ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å allCases ‡∏ï‡∏≤‡∏° filter ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      let cases = allCases.slice(); // copy

      cases = cases.filter(c => {
        if (c.status && c.status !== 'open') return false;

        const r = c.region || {};
        if (filterProvince.value && r.province !== filterProvince.value) return false;
        if (filterDistrict.value && r.district !== filterDistrict.value) return false;
        if (filterSubdistrict.value && r.subdistrict !== filterSubdistrict.value) return false;
        if (filterWater.value && String(c.waterLevel) !== filterWater.value) return false;
        return true;
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô)
      cases.sort((a,b) => {
        const ta = a.createdAt?.seconds || 0;
        const tb = b.createdAt?.seconds || 0;
        return tb - ta;
      });

      tbody.innerHTML = '';
      cases.forEach(c => {
        const region = c.region || {};
        const lat   = c.lat;
        const lng   = c.lng;
        const water = c.waterLevel ?? '-';

        let waterText = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${water}`;
        let waterClass = 'badge-level';
        const color = levelColor[water];
        if (color) waterText = `<span class="badge-level" style="background:${color}">‡∏£‡∏∞‡∏î‡∏±‡∏ö ${water}</span>`;
        else waterText = `<span class="badge-level" style="background:#777">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>`;

        const statusTag = (!c.status || c.status === 'open')
          ? '<span class="tag-open">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>'
          : '<span class="tag-resolved">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name || ''}</td>
          <td>${c.phone ? `<a href="tel:${c.phone}">${c.phone}</a>` : ''}</td>
          <td>
            ${region.province || ''}<br>
            ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}
          </td>
          <td>${waterText}</td>
          <td>${c.note || ''}</td>
          <td>${(typeof lat === 'number' && typeof lng === 'number') ? `${lat.toFixed(5)}, ${lng.toFixed(5)}` : ''}</td>
          <td>${statusTag}</td>
          <td>
            <button class="btn-done" data-id="${c.id}">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
            <button class="btn-del"  data-id="${c.id}">‡∏•‡∏ö</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      statusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ' + cases.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      renderMarkers(cases);
    }

    // ====== Subscribe Firestore ‡πÅ‡∏ö‡∏ö Realtime ======
    if (db) {
      const qOpen = query(collection(db, 'cases')); // ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏á
      onSnapshot(qOpen, (snap) => {
        const temp = [];
        snap.forEach(docSnap => {
          temp.push({ id: docSnap.id, ...docSnap.data() });
        });
        allCases = temp;
        renderTable();
      }, (err) => {
        console.error(err);
        statusEl.textContent = '‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        statusEl.classList.add('error');
      });
    }

    // ====== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ======
    tbody.addEventListener('click', async (e) => {
      const id = e.target.getAttribute('data-id');
      if (!id || !db) return;
      const ref = doc(db, 'cases', id);

      if (e.target.classList.contains('btn-done')) {
        if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?')) {
          await updateDoc(ref, {
            status: 'resolved',
            resolvedAt: serverTimestamp()
          });
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
      } else if (e.target.classList.contains('btn-del')) {
        if (confirm('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) {
          await deleteDoc(ref);
          alert('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
      }
    });

    // ====== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ render ‡πÉ‡∏´‡∏°‡πà ======
    [filterProvince, filterDistrict, filterSubdistrict, filterWater].forEach(sel => {
      sel.addEventListener('change', renderTable);
    });
  </script>
</body>
</html>
