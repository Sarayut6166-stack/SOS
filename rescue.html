<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; }
    .topbar {
      padding: 8px 12px;
      background:#1e88e5;
      color:#fff;
    }
    .topbar h1 {
      margin: 0;
      font-size: 18px;
    }
    .topbar small { font-size:12px; }

    #map { height: 40vh; }

    .container { padding: 8px 12px; max-width: 960px; margin:auto; }

    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td {
      border:1px solid #ddd;
      padding:4px;
      vertical-align: top;
    }
    th { background:#f0f0f0; }

    button {
      padding:4px 8px;
      font-size:12px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .btn-sync { background:#1565c0; color:#fff; }
    .btn-done { background:#43a047; color:#fff; margin-right:4px; }
    .btn-del  { background:#e53935; color:#fff; }

    #status { font-size:12px; margin-left:8px; }

    .filters { margin-top:6px; font-size:13px; }
    .filters select {
      margin:2px 2px 4px 0;
      padding:4px;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ - SOS</h1>
    <small>‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™</small>
    <div style="margin-top:4px;">
      <button class="btn-sync" id="btnSync">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
      <span id="status"></span>
    </div>

    <div class="filters">
      <div>
        <strong>‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong>
        <select id="filterDistrict">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
          <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
          <option value="‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
          <option value="‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°">‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°</option>
        </select>
        <select id="filterSubdistrict">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏• / ‡πÄ‡∏Ç‡∏ï / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</option>
          <option value="‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏">‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏</option>
          <option value="‡∏Ñ‡∏•‡∏≠‡∏á‡πÅ‡∏´">‡∏Ñ‡∏•‡∏≠‡∏á‡πÅ‡∏´</option>
          <option value="‡∏û‡∏∞‡∏ß‡∏á">‡∏û‡∏∞‡∏ß‡∏á</option>
        </select>
        <select id="filterVillage">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</option>
          <option value="‡∏´‡∏°‡∏π‡πà 1">‡∏´‡∏°‡∏π‡πà 1</option>
          <option value="‡∏´‡∏°‡∏π‡πà 2">‡∏´‡∏°‡∏π‡πà 2</option>
          <option value="‡∏´‡∏°‡∏π‡πà 3">‡∏´‡∏°‡∏π‡πà 3</option>
          <option value="‡∏´‡∏°‡∏π‡πà 4">‡∏´‡∏°‡∏π‡πà 4</option>
        </select>
      </div>
      <div>
        <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥:</strong>
        <select id="filterWater">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
          <option value="1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1</option>
          <option value="2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2</option>
          <option value="3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3</option>
          <option value="4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4</option>
          <option value="5">‡∏£‡∏∞‡∏î‡∏±‡∏ö 5 (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á)</option>
        </select>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <div class="container">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™)</h3>
    <table>
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="caseTableBody"></tbody>
    </table>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase config -->
  <script src="firebase-config.js"></script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      updateDoc,
      deleteDoc,
      doc,
      getDocs,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ‡πÄ‡∏õ‡∏¥‡∏î offline persistence (‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà sync ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î)
    enableIndexedDbPersistence(db).catch((err) => {
      console.log('persistence error', err.code);
    });

    // ----- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -----
    const map = L.map('map').setView([7.0, 100.5], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    const levelColor = {
      1: "#4caf50",
      2: "#8bc34a",
      3: "#ffeb3b",
      4: "#ff9800",
      5: "#f44336"
    };

    const markers = {};
    const tbody   = document.getElementById('caseTableBody');
    const statusEl = document.getElementById('status');
    const btnSync  = document.getElementById('btnSync');

    const filterDistrict   = document.getElementById('filterDistrict');
    const filterSubdistrict= document.getElementById('filterSubdistrict');
    const filterVillage    = document.getElementById('filterVillage');
    const filterWater      = document.getElementById('filterWater');

    let lastSnapshot = null;

    function matchesFilter(c) {
      const region = c.region || {};
      if (filterDistrict.value    && region.district   !== filterDistrict.value)   return false;
      if (filterSubdistrict.value && region.subdistrict!== filterSubdistrict.value)return false;
      if (filterVillage.value     && region.village    !== filterVillage.value)    return false;
      if (filterWater.value       && Number(filterWater.value) !== Number(c.waterLevel)) return false;
      return true;
    }

    function renderSnapshot() {
      if (!lastSnapshot) return;

      tbody.innerHTML = '';
      Object.values(markers).forEach(m => map.removeLayer(m));
      for (const id in markers) delete markers[id];

      lastSnapshot.forEach(docSnap => {
        const c  = docSnap.data();
        const id = docSnap.id;
        if (c.status !== 'open') return;
        if (!matchesFilter(c))  return;

        const region = c.region || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name || ''}</td>
          <td>${c.phone ? <a href="tel:${c.phone}">${c.phone}</a> : ''}</td>
          <td>
            ${region.province || ''}<br>
            ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}
          </td>
          <td>‡∏£‡∏∞‡∏î‡∏±‡∏ö ${c.waterLevel || '-'}</td>
          <td>${c.note || ''}</td>
          <td>${c.lat?.toFixed ? c.lat.toFixed(5) : ''}, ${c.lng?.toFixed ? c.lng.toFixed(5) : ''}</td>
          <td>
            <button class="btn-done" data-id="${id}">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
            <button class="btn-del"  data-id="${id}">‡∏•‡∏ö</button>
          </td>
        `;
        tbody.appendChild(tr);

        if (typeof c.lat === 'number' && typeof c.lng === 'number') {
          const color = levelColor[c.waterLevel] || "#000";
          const m = L.circleMarker([c.lat, c.lng], {
            radius: 9,
            color,
            fillColor: color,
            fillOpacity: 0.85
          }).addTo(map)
            .bindPopup(`
              <strong>${c.name || ''}</strong><br>
              ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${c.phone || ''}<br>
              ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏≠.${region.district || ''} ‡∏ï.${region.subdistrict || ''} ‡∏°.${region.village || ''}<br>
              ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥: ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${c.waterLevel || '-'}
            `);
          markers[id] = m;
        }
      });

      statusEl.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleTimeString('th-TH');
    }

    filterDistrict.onchange =
      filterSubdistrict.onchange =
      filterVillage.onchange =
      filterWater.onchange = () => renderSnapshot();

    // Realtime listener
    const q = query(
      collection(db, 'cases'),
      where('status','==','open'),
      orderBy('createdAt','desc')
    );

    onSnapshot(q, (snapshot) => {
      lastSnapshot = snapshot;
      renderSnapshot();
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
    btnSync.addEventListener('click', async () => {
      try {
        statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...';
        await getDocs(q);
        statusEl.textContent = '‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
      } catch (err) {
        statusEl.textContent = '‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)';
      }
    });

    // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß / ‡∏•‡∏ö ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    tbody.addEventListener('click', async (e) => {
      const id = e.target.getAttribute('data-id');
      if (!id) return;

      const ref = doc(db, 'cases', id);

      if (e.target.classList.contains('btn-done')) {
        if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?')) {
          await updateDoc(ref, {
            status: 'resolved'
          });
        }
      } else if (e.target.classList.contains('btn-del')) {
        if (confirm('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) {
          await deleteDoc(ref);
        }
      }
    });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÄ‡∏≠‡∏á (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if (!window._meMarker) {
          window._meMarker = L.circleMarker([lat, lng], {
            radius: 8,
            color: "#2196f3",
            fillColor: "#2196f3",
            fillOpacity: 0.9
          }).addTo(map).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢');
        } else {
          window._meMarker.setLatLng([lat, lng]);
        }
      });
    }
  </script>
</body>
</html>
