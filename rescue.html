<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ | SOS Rescue</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    .header {
      background: #1976d2;
      color: #fff;
      padding: 14px 10px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 20px;
    }
    .header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: .95;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 10px 40px;
    }

    .top-links {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .top-links a {
      text-decoration: none;
      color: #0d47a1;
    }

    /* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå */
    .filter-card, .legend-card {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.1);
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-group {
      flex: 1;
      min-width: 130px;
    }
    label { font-size: 12px; margin-bottom: 3px; display: block; }
    select, input[type="text"] {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      font-size: 13px;
      box-shadow: 0px 1px 4px rgba(0,0,0,0.2);
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    th {
      background: #e3f2fd;
      white-space: nowrap;
      font-weight: 600;
    }
    tr:last-child td { border-bottom: none; }

    .btn-map, .btn-finish {
      display: inline-block;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 11px;
      text-decoration: none;
      margin-bottom: 4px;
      color: white;
    }

    .btn-map { background: #1565c0; }
    .btn-finish { background: #2e7d32; margin-top: 4px; }

    .status-tag {
      background: #ef6c00;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .level-badge {
      padding: 3px 6px;
      border-radius: 999px;
      font-weight: 600;
      color: #fff;
      font-size: 11px;
    }
    .lv1 { background: #8bc34a; }
    .lv2 { background: #4caf50; }
    .lv3 { background: #ffb300; }
    .lv4 { background: #fb8c00; }
    .lv5 { background: #e53935; }

    .empty { text-align: center; padding: 12px; color: #777; }

    /* Popup Maps.me */
    #mapsmePopup {
      display:none;
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(0,0,0,0.6);
      z-index:9999;
      backdrop-filter:blur(2px);
    }
    #mapsmeBox {
      background:#fff;
      width:85%;
      max-width:350px;
      padding:16px;
      border-radius:12px;
      text-align:center;
      margin:120px auto 0;
      box-shadow:0 3px 10px rgba(0,0,0,.4);
    }
    #mapsmeBox h3 { margin:0 0 10px; }
    #mapsmeBox p { font-size:14px; color:#444; }
    .popup-btn {
      margin-top:10px;
      background:#2e7d32;
      padding:10px;
      border-radius:8px;
      color:#fff;
      text-decoration:none;
      display:block;
    }
    .popup-close {
      background:#555 !important;
      margin-top:8px;
    }

  </style>
</head>
<body>

  <div id="mapsmePopup">
    <div id="mapsmeBox">
      <h3>üìå ‡∏Ç‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone (iOS)</h3>
      <p>
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ GPS ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï<br>
        ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ <b>Maps.me</b> (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
      </p>

      <a class="popup-btn"
         href="https://apps.apple.com/us/app/maps-me-offline-maps-gps-nav/id510623322"
         target="_blank">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Maps.me</a>

      <a class="popup-btn popup-close" onclick="closePopup()">‡∏õ‡∏¥‡∏î</a>
    </div>
  </div>

  <script>
    function isIOS() {
      return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function closePopup() {
      document.getElementById("mapsmePopup").style.display = "none";
      localStorage.setItem("mapsmeSeen", Date.now() + (24 * 60 * 60 * 1000));
    }

    window.addEventListener("load", () => {
      if (!isIOS()) return;
      const seen = localStorage.getItem("mapsmeSeen");
      if (seen && Number(seen) > Date.now()) return;
      document.getElementById("mapsmePopup").style.display = "block";
    });
  </script>

  <div class="header">
    <h1>üöë ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ SOS</h1>
    <p>‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
  </div>

  <div class="container">

    <div class="top-links">
      <a href="index.html">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="history.html">‚úî ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</a>
    </div>

    <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ -->
    <div class="legend-card">
      <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</b>
      <ul style="font-size:12px; padding-left:16px;">
        <li><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö 1</b> ‚Äì ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</li>
        <li><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö 2</b> ‚Äì ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</li>
        <li><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö 3</b> ‚Äì ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</li>
        <li><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö 4</b> ‚Äì ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</li>
        <li><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö 5</b> ‚Äì ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á</li>
      </ul>
    </div>

    <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
    <div class="filter-card">
      <b>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b>
      <div class="filter-row">
        <div class="filter-group">
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
          <select id="filterProvince"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        </div>
        <div class="filter-group">
          <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
          <select id="filterDistrict"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        </div>
        <div class="filter-group">
          <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
          <select id="filterSubdistrict"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        </div>
        <div class="filter-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
          <input type="text" id="filterText" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." />
        </div>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="caseBody">
        <tr><td colspan="8" class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      </tbody>
    </table>

  </div>

  <script src="firebase-config.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      doc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const tbody = document.getElementById("caseBody");

    const pFilter = document.getElementById("filterProvince");
    const dFilter = document.getElementById("filterDistrict");
    const sFilter = document.getElementById("filterSubdistrict");
    const tFilter = document.getElementById("filterText");

    let allCases = [];

    function subscribeData() {
      const q = query(
        collection(db, "cases"),
        where("status", "==", "open")
      );

      onSnapshot(q, snap => {
        allCases = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        buildFilters();
        renderTable();
      });
    }

    function buildFilters() {
      const pSet = new Set(), dSet = new Set(), sSet = new Set();

      allCases.forEach(c => {
        const r = c.region || {};
        if (r.province) pSet.add(r.province);
        if (r.district) dSet.add(r.district);
        if (r.subdistrict) sSet.add(r.subdistrict);
      });

      function fill(sel, set) {
        const cur = sel.value;
        sel.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        [...set].sort().forEach(v => {
          sel.innerHTML += `<option>${v}</option>`;
        });
        if (cur && [...set].includes(cur)) sel.value = cur;
      }

      fill(pFilter, pSet);
      fill(dFilter, dSet);
      fill(sFilter, sSet);
    }

    function levelBadge(lv) {
      lv = Number(lv);
      if (lv === 1) return `<span class="level-badge lv1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1</span>`;
      if (lv === 2) return `<span class="level-badge lv2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2</span>`;
      if (lv === 3) return `<span class="level-badge lv3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3</span>`;
      if (lv === 4) return `<span class="level-badge lv4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4</span>`;
      if (lv === 5) return `<span class="level-badge lv5">‡∏£‡∏∞‡∏î‡∏±‡∏ö 5</span>`;
      return '-';
    }

    function showRegion(r) {
      if (!r) return "-";
      return [
        r.village || "",
        r.subdistrict || "",
        r.district || "",
        r.province || ""
      ].filter(Boolean).join(" / ");
    }

    function renderTable() {
      const p = pFilter.value;
      const d = dFilter.value;
      const s = sFilter.value;
      const t = tFilter.value.trim().toLowerCase();

      const data = allCases.filter(c => {
        const r = c.region || {};
        if (p && r.province !== p) return false;
        if (d && r.district !== d) return false;
        if (s && r.subdistrict !== s) return false;

        if (t) {
          const txt = `${c.name || ""} ${c.phone || ""}`.toLowerCase();
          if (!txt.includes(t)) return false;
        }
        return true;
      });

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map((c, i) => {
        const lat = c.lat, lng = c.lng;
        let maps = "-";

        if (typeof lat === "number" && typeof lng === "number") {

          const gUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
          const mUrl = `mapsme://map?ll=${lat},${lng}&n=‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢`;

          maps = `
            <a class="btn-map" href="${gUrl}" target="_blank">Google Maps</a><br>
            <a class="btn-map" href="${mUrl}">Maps.me</a>
          `;
        }

        return `
          <tr>
            <td>${i+1}</td>
            <td>${c.name || "-"}</td>
            <td>${c.phone || "-"}</td>
            <td>${showRegion(c.region)}</td>
            <td>${levelBadge(c.waterLevel)}</td>
            <td>${c.note || "-"}</td>
            <td>
              ${maps}<br>
              <button class="btn-finish" onclick="closeCase('${c.id}')">‚úî ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
            </td>
            <td><span class="status-tag">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span></td>
          </tr>
        `;
      }).join("");
    }

    window.closeCase = async function (id) {
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;

      await updateDoc(doc(db, "cases", id), {
        status: "closed",
        closedAt: serverTimestamp()
      });

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    };

    pFilter.onchange = renderTable;
    dFilter.onchange = renderTable;
    sFilter.onchange = renderTable;
    tFilter.oninput = renderTable;

    subscribeData();
  </script>

</body>
</html>
