<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</title>

  <!-- Leaflet map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:#f5f5f5; }
    #map { height: 45vh; }
    .container { max-width: 480px; margin: auto; padding: 12px; }
    h2 { margin: 8px 0; text-align:center; }
    label { display:block; margin-top:8px; font-size:14px; }
    input, textarea, select {
      width: 100%; padding: 8px; margin-top:4px;
      border-radius:8px; border:1px solid #ccc; font-size:15px;
    }
    button {
      width:100%; margin-top:14px; padding:10px;
      background:#e53935; color:#fff; font-size:16px;
      border:none; border-radius:8px;
    }
    #status { font-size:13px; margin-top:6px; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="container">
  <h2>üìç ‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</h2>

  <form id="reportForm">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</label>
    <input name="name" required>

    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
    <input name="phone" required>

    <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
    <select id="province" name="province" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
    </select>

    <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
    <select id="district" name="district" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
    </select>

    <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
    <select id="subdistrict" name="subdistrict" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
    </select>

    <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
    <input name="village" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà 3 ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≠‡∏á‡πÅ‡∏´">

    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</label>
    <select name="waterLevel" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á</option>
      <option value="1">1 - ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
      <option value="2">2 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</option>
      <option value="3">3 - ‡∏ô‡πâ‡∏≥‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
      <option value="4">4 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</option>
      <option value="5">5 - ‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á</option>
    </select>

    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</label>
    <input type="number" name="people" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 3" required>

    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
    <textarea name="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏Ø‡∏•‡∏Ø"></textarea>

    <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</button>
  </form>

  <p id="status"></p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="firebase-config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, addDoc, doc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ----------------- ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• ----------------- */
const URL_P = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
const URL_D = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
const URL_S = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

let provinces=[],districts=[],subdistricts=[];

async function loadThai() {
  provinces    = await (await fetch(URL_P)).json();
  districts    = await (await fetch(URL_D)).json();
  subdistricts = await (await fetch(URL_S)).json();

  provinces.forEach(p => {
    province.innerHTML += `<option>${p.name_th}</option>`;
  });
}
loadThai();

province.addEventListener("change",()=>{
  const p = provinces.find(x => x.name_th === province.value);
  district.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>`;
  subdistrict.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

  if(!p) return;
  districts.filter(d=>d.province_id===p.id)
           .forEach(d=> district.innerHTML += `<option>${d.name_th}</option>`);
});

district.addEventListener("change",()=>{
  const d = districts.find(x => x.name_th === district.value);
  subdistrict.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

  if(!d) return;
  subdistricts.filter(s=>s.district_id===d.id)
              .forEach(s=> subdistrict.innerHTML += `<option>${s.name_th}</option>`);
});

/* ----------------- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ----------------- */
const map = L.map("map").setView([13,100], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker = L.marker([13,100],{draggable:true}).addTo(map);

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    marker.setLatLng([lat,lng]);
    map.setView([lat,lng],15);
  });
}

map.on("click",e=> marker.setLatLng(e.latlng));

/* ----------------- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥ ----------------- */
async function deleteOldCase(phone){
  const q = query(collection(db,"cases"), where("phone","==",phone));
  const snap = await getDocs(q);
  snap.forEach(async d => await deleteDoc(doc(db,"cases",d.id)));
}

/* ----------------- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ----------------- */
reportForm.addEventListener("submit", async e=>{
  e.preventDefault();
  status.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const latlng = marker.getLatLng();

  await deleteOldCase(reportForm.phone.value);

  const data = {
    name   : reportForm.name.value,
    phone  : reportForm.phone.value,
    people : Number(reportForm.people.value),
    note   : reportForm.note.value,
    lat    : latlng.lat,
    lng    : latlng.lng,
    region : {
      province   : province.value,
      district   : district.value,
      subdistrict: subdistrict.value,
      village    : reportForm.village.value
    },
    waterLevel: Number(reportForm.waterLevel.value),
    status: "open",
    createdAt: serverTimestamp()
  };

  try {
    await addDoc(collection(db,"cases"), data);
    status.textContent = "‚úî ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    reportForm.reset();
  } catch (err) {
    status.textContent = "‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
  }
});
</script>

</body>
</html>
