<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:#f5f5f5; }
    #map { height: 48vh; }

    .container { max-width: 480px; margin: auto; padding: 12px; }
    h2 { margin: 8px 0; text-align:center; }
    p  { font-size:14px; color:#555; }

    label {
      display:block;
      margin-top:8px;
      font-size:14px;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top:4px;
      padding: 8px;
      font-size: 15px;
      box-sizing: border-box;
      border-radius:8px;
      border:1px solid #ccc;
    }
    textarea { resize: vertical; }

    button {
      margin-top:14px;
      background:#e53935;
      color:#fff;
      border:none;
      font-weight:600;
      box-shadow:0 3px 8px rgba(0,0,0,0.2);
    }

    #status { font-size:13px; margin-top:6px; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="container">
  <h2>üìç ‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</h2>
  <p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ GPS ‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</p>

  <form id="reportForm">

    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</label>
    <input name="name" required>

    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
    <input name="phone" required>

    <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
    <select name="province" id="province" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
    </select>

    <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
    <select name="district" id="district" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
    </select>

    <label>‡∏ï‡∏≥‡∏ö‡∏• / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</label>
    <select name="subdistrict" id="subdistrict" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
    </select>

    <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
    <select name="village" id="village" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
    </select>

    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</label>
    <input type="number" name="people" min="0" value="0" required>

    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</label>
    <select name="waterLevel" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</option>
      <option value="1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 - ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
      <option value="2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</option>
      <option value="3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
      <option value="4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</option>
      <option value="5">‡∏£‡∏∞‡∏î‡∏±‡∏ö 5 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á</option>
    </select>

    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
    <textarea name="note" rows="3"></textarea>

    <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</button>
  </form>

  <p id="status"></p>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase config -->
<script src="firebase-config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, where,
  getDocs, serverTimestamp, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* =====================================================
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
===================================================== */

let provinces=[], districts=[], subdistricts=[];
const URL_P="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
const URL_D="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
const URL_S="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

async function loadProvinceData(){
  provinces    = await (await fetch(URL_P)).json();
  districts    = await (await fetch(URL_D)).json();
  subdistricts = await (await fetch(URL_S)).json();

  const p = document.getElementById("province");
  provinces.forEach(pr=>{
    p.innerHTML += `<option>${pr.name_th}</option>`;
  });
}

loadProvinceData();

/* ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ */
document.getElementById("province").addEventListener("change",()=>{
  const pName = document.getElementById("province").value;
  const pObj  = provinces.find(x=>x.name_th===pName);

  const d = document.getElementById("district");
  d.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>`;

  const s = document.getElementById("subdistrict");
  s.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

  const v = document.getElementById("village");
  v.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>`;

  if(pObj){
    districts.filter(x=>x.province_id===pObj.id)
      .forEach(dd=> d.innerHTML += `<option>${dd.name_th}</option>`);
  }
});

/* ‡∏ï‡∏≥‡∏ö‡∏• */
document.getElementById("district").addEventListener("change",()=>{
  const dName = document.getElementById("district").value;
  const dObj  = districts.find(x=>x.name_th===dName);

  const s = document.getElementById("subdistrict");
  s.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

  const v = document.getElementById("village");
  v.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>`;

  if(dObj){
    subdistricts.filter(x=>x.district_id===dObj.id)
      .forEach(ss=> s.innerHTML += `<option>${ss.name_th}</option>`);
  }
});

/* ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏´‡∏°‡∏π‡πà 1‚Äì15 */
document.getElementById("subdistrict").addEventListener("change",()=>{
  const v = document.getElementById("village");
  v.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>`;
  for(let i=1;i<=15;i++){
    v.innerHTML += `<option>‡∏´‡∏°‡∏π‡πà ${i}</option>`;
  }
});

/* =====================================================
   ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Satellite (ESRI)
===================================================== */

const map = L.map('map').setView([7.0,100.5], 14);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{x}/{y}",
  {
    maxZoom: 20,
    attribution: "¬© Esri ‚Äî Source: Esri, NASA, NGA"
  }
).addTo(map);

let marker = L.marker([7.0,100.5], {draggable:true}).addTo(map);

/* ‡πÉ‡∏ä‡πâ GPS ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    marker.setLatLng([lat,lng]);
    map.setView([lat,lng], 17);
  });
}

/* ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î */
map.on("click", e=>{
  marker.setLatLng(e.latlng);
});

/* =====================================================
   ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
===================================================== */

const form = document.getElementById("reportForm");
const statusEl = document.getElementById("status");

form.addEventListener("submit", async (e)=>{
  e.preventDefault();

  const latlng = marker.getLatLng();
  const phone  = form.phone.value.trim();

  statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå...";

  /* ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏ã‡πâ‡∏≥ */
  const q = query(
    collection(db,"cases"),
    where("phone","==",phone),
    where("status","==","open")
  );

  const snap = await getDocs(q);

  /* ‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ ‚Üí ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ */
  if(!snap.empty){
    snap.forEach(async docx=>{
      await deleteDoc(doc(db,"cases",docx.id));
    });
  }

  statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const data = {
    name : form.name.value,
    phone: phone,
    people: Number(form.people.value),
    note : form.note.value,

    lat  : latlng.lat,
    lng  : latlng.lng,

    region:{
      province   : form.province.value,
      district   : form.district.value,
      subdistrict: form.subdistrict.value,
      village    : form.village.value
    },

    waterLevel : Number(form.waterLevel.value),
    status     : "open",
    createdAt  : serverTimestamp()
  };

  try{
    await addDoc(collection(db,"cases"), data);
    statusEl.textContent = "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî";
    form.reset();
  }
  catch(err){
    statusEl.textContent = "‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  }
});
</script>

</body>
</html>
