<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background:#f5f5f5;
    }
    #map { height: 45vh; }

    .container {
      max-width: 480px;
      margin: auto;
      padding: 12px;
    }
    h2 { text-align:center; margin: 10px 0; }
    label { margin-top:10px; display:block; font-size:14px; }
    input, select, textarea {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid #ccc; margin-top:4px;
    }
    button {
      width:100%; padding:12px; margin-top:16px;
      background:#d32f2f; color:#fff; border:none;
      border-radius:8px; font-size:16px; font-weight:bold;
    }
    #status { margin-top:8px; font-size:14px; color:#333; }
    .hint { font-size:12px; color:#666; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="container">
  <h2>üìç ‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</h2>

  <form id="reportForm">

    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</label>
    <input name="name" required>

    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
    <input name="phone" type="tel" required>

    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
    <textarea name="note" rows="2"></textarea>

    <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
    <select id="provinceSelect" name="province" required>
      <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
    </select>

    <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
    <select id="districtSelect" name="district" disabled required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</option>
    </select>

    <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
    <select id="subdistrictSelect" name="subdistrict" disabled required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô</option>
    </select>

    <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
    <input name="village" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà 1, ‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å">

    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</label>
    <select name="waterLevel" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
      <option value="1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 - ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
      <option value="2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</option>
      <option value="3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
      <option value="4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</option>
      <option value="5">‡∏£‡∏∞‡∏î‡∏±‡∏ö 5 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á</option>
    </select>

    <p class="hint">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏±‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>

    <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</button>
  </form>

  <p id="status"></p>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="firebase-config.js"></script>

<!-- Firebase v10 -->
<script type="module">
  import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    getDocs,
    query,
    where,
    serverTimestamp,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ---------- MAP ----------
  const map = L.map('map').setView([7.0, 100.5], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let marker = L.marker([7.0, 100.5], { draggable:true }).addTo(map);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      marker.setLatLng([lat, lng]);
      map.setView([lat, lng], 15);
    });
  }

  map.on("click", e => marker.setLatLng(e.latlng));

  // ---------- LOAD THAI PROVINCE DATA ----------
  const P_URL = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/province.json";
  const D_URL = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/district.json";
  const S_URL = "https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/sub_district.json";

  let provinces = [];
  let districts = [];
  let subdistricts = [];

  const provinceSelect = document.getElementById("provinceSelect");
  const districtSelect = document.getElementById("districtSelect");
  const subdistrictSelect = document.getElementById("subdistrictSelect");

  async function loadThaiData() {
    provinces = await (await fetch(P_URL)).json();
    districts = await (await fetch(D_URL)).json();
    subdistricts = await (await fetch(S_URL)).json();

    provinceSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>';
    provinces.forEach(p => {
      provinceSelect.innerHTML += `<option>${p.name_th}</option>`;
    });
  }

  provinceSelect.addEventListener("change", () => {
    const p = provinces.find(x => x.name_th === provinceSelect.value);
    districtSelect.disabled = false;

    const d = districts.filter(x => x.province_id === p.id);
    districtSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
    d.forEach(v => districtSelect.innerHTML += `<option>${v.name_th}</option>`);
  });

  districtSelect.addEventListener("change", () => {
    const d = districts.find(x => x.name_th === districtSelect.value);
    subdistrictSelect.disabled = false;

    const s = subdistricts.filter(x => x.district_id === d.id);
    subdistrictSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
    s.forEach(v => subdistrictSelect.innerHTML += `<option>${v.name_th}</option>`);
  });

  loadThaiData();

  // ---------- FORM SUBMIT ----------
  const form = document.getElementById("reportForm");
  const statusEl = document.getElementById("status");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const phoneInput = form.phone.value.trim();
    statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤...";

    try {

      // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
      const q = query(collection(db, "cases"), where("phone", "==", phoneInput));
      const snap = await getDocs(q);

      // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏Å‡πà‡∏≤ ‚Üí ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
      if (!snap.empty) {
        for (const d of snap.docs) {
          await deleteDoc(doc(db, "cases", d.id));
        }
      }

      // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      const latlng = marker.getLatLng();

      const data = {
        name : form.name.value.trim(),
        phone: phoneInput,
        note : form.note.value.trim(),
        lat  : latlng.lat,
        lng  : latlng.lng,
        region: {
          province   : form.province.value,
          district   : form.district.value,
          subdistrict: form.subdistrict.value,
          village    : form.village.value.trim()
        },
        waterLevel: Number(form.waterLevel.value),
        status    : "open",
        createdAt : serverTimestamp()
      };

      await addDoc(collection(db, "cases"), data);

      statusEl.textContent = "‚úî ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
      alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      form.reset();

    } catch (err) {
      console.error(err);
      statusEl.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
    }
  });
</script>

</body>
</html>
