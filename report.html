<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, sans-serif; 
      background:#f5f5f5; 
    }
    #map { height: 45vh; }

    .container { max-width: 480px; margin: auto; padding: 12px; }
    h2 { margin: 8px 0; text-align:center; }
    p  { font-size:14px; color:#555; }

    label {
      display:block;
      margin-top:8px;
      font-size:14px;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top:4px;
      padding: 8px;
      font-size: 15px;
      box-sizing: border-box;
      border-radius:8px;
      border:1px solid #ccc;
    }
    textarea { resize: vertical; }

    button {
      margin-top:14px;
      background:#e53935;
      color:#fff;
      border:none;
      font-weight:600;
      box-shadow:0 3px 8px rgba(0,0,0,0.2);
    }

    #status { font-size:13px; margin-top:6px; color:#333; }
  </style>
</head>

<body>

  <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° -->
  <div id="map"></div>

  <div class="container">
    <h2>üìç ‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</h2>
    <p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ GPS ‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <form id="reportForm">

      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</label>
      <input name="name" required>

      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
      <input name="phone" required>

      <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
      <select name="province" required id="province">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
      </select>

      <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
      <select name="district" required id="district">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
      </select>

      <label>‡∏ï‡∏≥‡∏ö‡∏• / ‡πÄ‡∏Ç‡∏ï / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</label>
      <select name="subdistrict" required id="subdistrict">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• / ‡πÄ‡∏Ç‡∏ï / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</option>
      </select>

      <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
      <input name="village" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà 4 / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ó‡πà‡∏≤‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏ô">

      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</label>
      <input type="number" name="people" min="0" value="0" required>

      <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</label>
      <select name="waterLevel" required>
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥</option>
        <option value="1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 - ‡∏ô‡πâ‡∏≥‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏•</option>
        <option value="2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤</option>
        <option value="3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
        <option value="4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á</option>
        <option value="5">‡∏£‡∏∞‡∏î‡∏±‡∏ö 5 - ‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á</option>
      </select>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
      <textarea name="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á, ‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å, ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏±‡πâ‡∏ô 2 ‡∏Ø‡∏•‡∏Ø"></textarea>

      <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</button>
    </form>

    <p id="status"></p>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase config -->
  <script src="firebase-config.js"></script>

  <!-- ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å -->
  <script type="module">
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ----------------------- ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• ----------------------- */
    const URL_P="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/province.json";
    const URL_D="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/district.json";
    const URL_S="https://raw.githubusercontent.com/kongvut/thai-province-data/master/api/latest/sub_district.json";

    let provinces=[], districts=[], subdistricts=[];
    const selP = document.getElementById("province");
    const selD = document.getElementById("district");
    const selS = document.getElementById("subdistrict");

    async function loadThai(){
      provinces    = await (await fetch(URL_P)).json();
      districts    = await (await fetch(URL_D)).json();
      subdistricts = await (await fetch(URL_S)).json();

      provinces.forEach(p=>{
        selP.innerHTML += `<option>${p.name_th}</option>`;
      });
    }
    loadThai();

    selP.addEventListener("change",()=>{
      const p = provinces.find(x=>x.name_th===selP.value);
      selD.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>`;
      selS.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

      if(p){
        districts
          .filter(d=>d.province_id===p.id)
          .forEach(d=> selD.innerHTML += `<option>${d.name_th}</option>`);
      }
    });

    selD.addEventListener("change",()=>{
      const d = districts.find(x=>x.name_th===selD.value);
      selS.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>`;

      if(d){
        subdistricts
          .filter(s=>s.district_id===d.id)
          .forEach(s=> selS.innerHTML += `<option>${s.name_th}</option>`);
      }
    });

    /* ----------------------- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° ----------------------- */

    const map = L.map('map').setView([13.736, 100.523], 12);

    // ‚úÖ ESRI World Imagery (‡πÅ‡∏Å‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö tile ‡πÄ‡∏õ‡πá‡∏ô {z}/{y}/{x})
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 20,
        attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, NASA, NGA, USGS'
      }
    ).addTo(map);

    let marker = L.marker([13.736, 100.523], { draggable:true }).addTo(map);

    // ‡πÉ‡∏ä‡πâ GPS ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 16);
      });
    }

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î
    map.on('click', e => {
      marker.setLatLng(e.latlng);
    });

    /* ----------------------- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ----------------------- */
    const form = document.getElementById('reportForm');
    const statusEl = document.getElementById('status');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const latlng = marker.getLatLng();

      const data = {
        name : form.name.value,
        phone: form.phone.value,
        note : form.note.value,
        people: Number(form.people.value),

        lat: latlng.lat,
        lng: latlng.lng,

        region: {
          province   : form.province.value,
          district   : form.district.value,
          subdistrict: form.subdistrict.value,
          village    : form.village.value
        },

        waterLevel: Number(form.waterLevel.value),
        status    : 'open',
        createdAt : serverTimestamp()
      };

      statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

      try {
        await addDoc(collection(db,'cases'), data);
        statusEl.textContent = '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö ‚úî';
        form.reset();
      }
      catch(err){
        console.error(err);
        statusEl.textContent = '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
      }
    });

  </script>

</body>
</html>
